using DotnetDependencyAnalyzer.NetCore.PackageUtils;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;

namespace DotnetDependencyAnalyzer.NetCore.Vulnerabilities
{
    public class VulnerabilityEvaluation
    {
        private static readonly string apiUrl = "http://35.234.147.77/nuget/dependency/vulnerabilities";

        public static async Task<VulnerabilityEvaluationResult[]> EvaluatePackage(List<NuGetPackage> packages, int maxAge)
        {
            List<Artifacts> artifacts = new List<Artifacts>();
            packages.ForEach(package => artifacts.Add(new Artifacts("nuget", package.Id, package.Version)));
            string body = JsonConvert.SerializeObject(artifacts);
            HttpClient httpClient = DependencyAnalyzer.Client;
            HttpContent content = new StringContent(body, Encoding.UTF8, "application/json");
            content.Headers.Add("Cache-Control", $"max-age={maxAge}");
            HttpResponseMessage resp = await httpClient.PostAsync(apiUrl, content);    
            if (resp.IsSuccessStatusCode)
            {
                var respBody = await resp.Content.ReadAsStringAsync();
                VulnerabilityEvaluationResult[] vulnerabilityEvaluationResult = JsonConvert.DeserializeObject<VulnerabilityEvaluationResult[]>(respBody);
                return vulnerabilityEvaluationResult;
            }
            return null;
        }
    }

    [Serializable]
    class Artifacts
    {
        [JsonProperty("pm")]
        public string Pm;

        [JsonProperty("name")]
        public string Name;

        [JsonProperty("version")]
        public string Version;

        public Artifacts(string pm, string id, string version)
        {
            Pm = pm;
            Name = id;
            Version = version;
        }
    }
}
