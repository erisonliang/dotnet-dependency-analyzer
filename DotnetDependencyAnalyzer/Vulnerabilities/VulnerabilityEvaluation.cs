using DotnetDependencyAnalyzer.PackageUtils;
using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Threading.Tasks;

namespace DotnetDependencyAnalyzer.Vulnerabilities
{
    public class VulnerabilityEvaluation
    {
        private static readonly string apiUrl = "http://35.234.147.77/nuget/dependency/vulnerabilities";

        public static async Task<VulnerabilityEvaluationResult[]> EvaluatePackage(List<NuGetPackage> packages, int maxAge)
        {
            List<Artifacts> artifacts = new List<Artifacts>();
            packages.ForEach(package => artifacts.Add(new Artifacts("nuget", package.Id, package.Version)));
            string body = JsonConvert.SerializeObject(artifacts);
            HttpClient httpClient = DependencyAnalyzer.Client;
            HttpRequestMessage req = new HttpRequestMessage(HttpMethod.Post, apiUrl)
            {
                Content = new StringContent(body, Encoding.UTF8, "application/json")
            };
            req.Headers.CacheControl = new CacheControlHeaderValue() { MaxAge = new TimeSpan(0, 0, maxAge) };
            HttpResponseMessage resp = await httpClient.SendAsync(req);
            if (resp.IsSuccessStatusCode)
            {
                var respBody = await resp.Content.ReadAsStringAsync();
                VulnerabilityEvaluationResult[] vulnerabilityEvaluationResult = JsonConvert.DeserializeObject<VulnerabilityEvaluationResult[]>(respBody);
                return vulnerabilityEvaluationResult;
            }
            return null;
        }
    }

    [Serializable]
    class Artifacts
    {
        [JsonProperty("pm")]
        public string Pm;

        [JsonProperty("name")]
        public string Name;

        [JsonProperty("version")]
        public string Version;

        public Artifacts(string pm, string id, string version)
        {
            Pm = pm;
            Name = id;
            Version = version;
        }
    }
}
